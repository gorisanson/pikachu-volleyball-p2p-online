{"version":3,"sources":["webpack:///./src/resources/js/pikavolley_online.js","webpack:///./src/resources/js/main_online.js"],"names":["stage","resources","super","this","physics","player1","isComputer","player2","keyboardArray","unsubscribe","myKeyboard","myOnlineKeyboard","inputQueue","peerOnlineKeyboard","peerInputQueue","_amIPlayer2","_syncCounter","noInputFrameTotal","menu","Infinity","isFirstGame","willSaveReplay","bool","amIPlayer2","counter","mod","frameCounter","selectedWithWho","amICreatedRoom","isQuickMatch","intro","myNickname","peerNickname","myPartialPublicIP","peerPartialPublicIP","gameStartAllowed","isOpen","getInputIfNeededAndSendToPeer","syncCounter","gameLoopFromGettingPeerInput","isInputOnQueue","callbackAfterPeerInputQueueReceived","bind","getInput","player1Input","xDirection","yDirection","powerHit","player2Input","recordInputs","slowMotionFramesLeft","slowMotionNumOfSkippedFrames","Math","round","normalFPS","slowMotionFPS","state","length","window","setTimeout","gameLoop","TEXTURES","WITH_COMPUTER","WITH_FRIEND","settings","RESOLUTION","devicePixelRatio","SCALE_MODE","NEAREST","ROUND_PIXELS","renderer","width","height","antialias","backgroundColor","transparent","ticker","loader","document","querySelector","appendChild","view","render","add","SPRITE_SHEET","prop","SOUNDS","setup","pikaVolley","maxFPS","start","loadingBox","getElementById","progressBar","onProgress","style","progress","onComplete","classList","contains","setUpLoaderProgresBar","callbackAfterDataChannelOpened","load"],"mappings":"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","file":"main.9bc22d21ba34c4dc154f.js","sourcesContent":["'use strict';\r\nimport { PikachuVolleyball } from './offline_version_js/pikavolley.js';\r\nimport { bufferLength, myKeyboard, OnlineKeyboard } from './keyboard_online.js';\r\nimport { SYNC_DIVISOR, channel } from './data_channel/data_channel';\r\nimport { mod } from './utils/mod.js';\r\nimport { askOneMoreGame } from './ui_online.js';\r\nimport { displayPartialIPFor, displayNicknameFor } from './nickname_display.js';\r\nimport { replaySaver } from './replay/replay_saver.js';\r\nimport { PikaUserInput } from './offline_version_js/physics.js';\r\n\r\n/** @typedef GameState @type {function():void} */\r\n\r\n/**\r\n * Class reperesenting Pikachu Volleyball p2p online game\r\n */\r\n// @ts-ignore\r\nexport class PikachuVolleyballOnline extends PikachuVolleyball {\r\n  constructor(stage, resources) {\r\n    super(stage, resources);\r\n    this.physics.player1.isComputer = false;\r\n    this.physics.player2.isComputer = false;\r\n\r\n    // @ts-ignore\r\n    this.keyboardArray[0].unsubscribe();\r\n    // @ts-ignore\r\n    this.keyboardArray[1].unsubscribe();\r\n\r\n    this.myKeyboard = myKeyboard;\r\n    this.myOnlineKeyboard = new OnlineKeyboard(this.myKeyboard.inputQueue);\r\n    this.peerOnlineKeyboard = new OnlineKeyboard(channel.peerInputQueue);\r\n\r\n    this._amIPlayer2 = false;\r\n    this.keyboardArray = [this.myOnlineKeyboard, this.peerOnlineKeyboard];\r\n    this._syncCounter = 0;\r\n    this.noInputFrameTotal.menu = Infinity;\r\n\r\n    this.isFirstGame = true;\r\n\r\n    this.willSaveReplay = true;\r\n  }\r\n\r\n  /**\r\n   * @return {boolean}\r\n   */\r\n  get amIPlayer2() {\r\n    return this._amIPlayer2;\r\n  }\r\n\r\n  /**\r\n   * @param {boolean} bool Am I Player 2? Am I play on the right side?\r\n   */\r\n  set amIPlayer2(bool) {\r\n    this._amIPlayer2 = bool;\r\n    channel.amIPlayer2 = bool;\r\n    if (this._amIPlayer2 === true) {\r\n      this.keyboardArray = [this.peerOnlineKeyboard, this.myOnlineKeyboard];\r\n    } else {\r\n      this.keyboardArray = [this.myOnlineKeyboard, this.peerOnlineKeyboard];\r\n    }\r\n  }\r\n\r\n  get syncCounter() {\r\n    return this._syncCounter;\r\n  }\r\n\r\n  set syncCounter(counter) {\r\n    this._syncCounter = mod(counter, SYNC_DIVISOR);\r\n  }\r\n\r\n  /**\r\n   * Override the \"intro\" method in the super class.\r\n   * It is to ask for one more game with the peer after quick match game ends.\r\n   * @type {GameState}\r\n   */\r\n  intro() {\r\n    if (this.frameCounter === 0) {\r\n      this.selectedWithWho = 0;\r\n      if (this.isFirstGame) {\r\n        this.isFirstGame = false;\r\n        this.amIPlayer2 = !channel.amICreatedRoom;\r\n      } else if (channel.isQuickMatch) {\r\n        askOneMoreGame();\r\n      }\r\n    }\r\n    super.intro();\r\n  }\r\n\r\n  /**\r\n   * Override the \"menu\" method in the super class.\r\n   * It changes \"am I player 1 or player 2\" setting accordingly.\r\n   * @type {GameState}\r\n   */\r\n  menu() {\r\n    const selectedWithWho = this.selectedWithWho;\r\n    super.menu();\r\n    if (this.selectedWithWho !== selectedWithWho) {\r\n      this.amIPlayer2 = !this.amIPlayer2;\r\n      displayNicknameFor(channel.myNickname, this.amIPlayer2);\r\n      displayNicknameFor(channel.peerNickname, !this.amIPlayer2);\r\n      displayPartialIPFor(channel.myPartialPublicIP, this.amIPlayer2);\r\n      displayPartialIPFor(channel.peerPartialPublicIP, !this.amIPlayer2);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Game loop\r\n   * This function should be called at regular intervals ( interval = (1 / FPS) second )\r\n   */\r\n  gameLoop() {\r\n    if (!(channel.gameStartAllowed && channel.isOpen)) {\r\n      return;\r\n    }\r\n\r\n    // Sync game frame and user input with peer\r\n    //\r\n    // This must be before the slow-mo effect.\r\n    // Otherwise, frame sync could be broken,\r\n    // for example, if peer use other tap on the browser\r\n    // so peer's game pause while my game goes on slow-mo.\r\n    // This broken frame sync results into different game state between two peers.\r\n    this.myKeyboard.getInputIfNeededAndSendToPeer(this.syncCounter);\r\n    this.gameLoopFromGettingPeerInput();\r\n  }\r\n\r\n  gameLoopFromGettingPeerInput() {\r\n    const checkForPeerInputQueue = this.peerOnlineKeyboard.isInputOnQueue(\r\n      this.syncCounter\r\n    );\r\n    if (!checkForPeerInputQueue) {\r\n      channel.callbackAfterPeerInputQueueReceived = this.gameLoopFromGettingPeerInput.bind(\r\n        this\r\n      );\r\n      return;\r\n    }\r\n    const checkForMyInputQueue = this.myOnlineKeyboard.isInputOnQueue(\r\n      this.syncCounter\r\n    );\r\n    if (!checkForMyInputQueue) {\r\n      return;\r\n    }\r\n    this.peerOnlineKeyboard.getInput(this.syncCounter);\r\n    this.myOnlineKeyboard.getInput(this.syncCounter);\r\n    this.syncCounter++;\r\n\r\n    if (this.willSaveReplay) {\r\n      const player1Input = new PikaUserInput();\r\n      player1Input.xDirection = this.keyboardArray[0].xDirection;\r\n      player1Input.yDirection = this.keyboardArray[0].yDirection;\r\n      player1Input.powerHit = this.keyboardArray[0].powerHit;\r\n      const player2Input = new PikaUserInput();\r\n      player2Input.xDirection = this.keyboardArray[1].xDirection;\r\n      player2Input.yDirection = this.keyboardArray[1].yDirection;\r\n      player2Input.powerHit = this.keyboardArray[1].powerHit;\r\n      replaySaver.recordInputs(player1Input, player2Input);\r\n    }\r\n\r\n    // slow-mo effect\r\n    if (this.slowMotionFramesLeft > 0) {\r\n      this.slowMotionNumOfSkippedFrames++;\r\n      if (\r\n        this.slowMotionNumOfSkippedFrames %\r\n          Math.round(this.normalFPS / this.slowMotionFPS) !==\r\n        0\r\n      ) {\r\n        return;\r\n      }\r\n      this.slowMotionFramesLeft--;\r\n      this.slowMotionNumOfSkippedFrames = 0;\r\n    }\r\n\r\n    this.physics.player1.isComputer = false;\r\n    this.physics.player2.isComputer = false;\r\n    this.state();\r\n\r\n    // window.setTimeout(callback, 0) is used because it puts\r\n    // the callback to the message queue of Javascript runtime event loop,\r\n    // so the callback does not stack upon the stack of the caller function and\r\n    // also does not block if the callbacks are called a bunch in a row.\r\n    if (this.peerOnlineKeyboard.inputQueue.length > bufferLength) {\r\n      if (this.myOnlineKeyboard.inputQueue.length > bufferLength) {\r\n        window.setTimeout(this.gameLoopFromGettingPeerInput.bind(this), 0);\r\n      } else {\r\n        window.setTimeout(this.gameLoop.bind(this), 0);\r\n      }\r\n    }\r\n  }\r\n}\r\n","/**\r\n * This is the main script which executes the p2p online version game.\r\n * General explanations for the all source code files of the game are following.\r\n *\r\n ********************************************************************************************************************\r\n * This p2p online version of the Pikachu Volleyball is developed based on\r\n * the Pikachu Volleyball offline web version (https://github.com/gorisanson/pikachu-volleyball)\r\n * which is made by reverse engineering the core part of the original Pikachu Volleyball game\r\n * which is developed by \"1997 (C) SACHI SOFT / SAWAYAKAN Programmers\" & \"1997 (C) Satoshi Takenouchi\".\r\n ********************************************************************************************************************\r\n *\r\n * This p2p online version game is mainly composed of two parts below.\r\n *  1) Offline version: All the offline web version source code files is in the directory \"offline_version_js\".\r\n *  2) WebRTC data channels: It utilizes WebRTC data channels to communicate with the peer.\r\n *                           The peer-to-peer online functions are contained in \"data_channel.js\"\r\n *\r\n * The game is deterministic on the user (keyboard) inputs except the RNG (random number generator) used in\r\n * \"offline_version_js/physics.js\" and \"offline_version_js/cloud_and_wave.js\". (The RNG is contained\r\n * in \"offline_version_js/rand.js\".) So if the RNG is the same on both peers, only the user inputs need\r\n * to be communicated to maintain the same game state between the peers. In this p2p online version, the RNG\r\n * is set to the same thing on both peers at the data channel open event (handled by the function\r\n * \"dataChannelOpened\" in \"data_channel.js\"), then the user inputs are communicated via the data channel.\r\n *\r\n * And expainations for other source files are below.\r\n *  - \"pikavolley_online.js\": A wrapper for \"offline_version_js/pikavolley.js\".\r\n *  - \"keyboard_online.js\": A wrapper for offline version \"offline_version_js/keyboard.js\".\r\n *                          This module gets user inputs and load them up onto the data channel to the peer.\r\n *  - \"generate_pushid.js\": Generate a room ID easilly distinguishable by human eye.\r\n *  - \"mod.js\": To maintain game sync, sync counter is attached for each user input, and mod is used to\r\n *              make sync counter cycle in a range [0, 255] which fits in a byte.\r\n *  - \"ui_online.js\": For the user interface of the html page and inputs/outputs relevant to html elements.\r\n *  - \"chat_display.js\": For displaying chat messages.\r\n *  - \"firebase_config.template.js\": This p2p online version utilized firebase cloud firestore to establish\r\n *                                   webRTC data channel connection between peers. Fill this template and\r\n *                                   change the file name to \"firebase_config.js\".\r\n *  - \"rtc_configuration.js\": Contains RTCPeerConnection configuration.\r\n *  - \"quick_match.js\": It is for the quick match function. Manages communication with the quick match server.\r\n *  - \"qucik_match_server_url.template.js\": Fill this template the url of the quick match server and change\r\n *                                          the file name to \"qucik_match_server_url.js\"\r\n */\r\n'use strict';\r\nimport * as PIXI from 'pixi.js-legacy';\r\nimport 'pixi-sound';\r\nimport { PikachuVolleyballOnline } from './pikavolley_online.js';\r\nimport { ASSETS_PATH } from './offline_version_js/assets_path.js';\r\nimport { channel } from './data_channel/data_channel.js';\r\nimport { setUpUI, setUpUIAfterLoadingGameAssets } from './ui_online.js';\r\nimport { setGetSpeechBubbleNeeded } from './chat_display.js';\r\nimport '../style.css';\r\n\r\nconst TEXTURES = ASSETS_PATH.TEXTURES;\r\nTEXTURES.WITH_COMPUTER = TEXTURES.WITH_FRIEND;\r\n\r\nconst settings = PIXI.settings;\r\nsettings.RESOLUTION = window.devicePixelRatio;\r\nsettings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;\r\nsettings.ROUND_PIXELS = true;\r\n\r\nconst renderer = PIXI.autoDetectRenderer({\r\n  width: 432,\r\n  height: 304,\r\n  antialias: false,\r\n  backgroundColor: 0x000000,\r\n  transparent: false,\r\n});\r\nconst stage = new PIXI.Container();\r\nconst ticker = new PIXI.Ticker();\r\nconst loader = new PIXI.Loader();\r\n\r\ndocument.querySelector('#game-canvas-container').appendChild(renderer.view);\r\n\r\nrenderer.render(stage); // To make the initial canvas painting stable in the Firefox browser.\r\nloader.add(ASSETS_PATH.SPRITE_SHEET);\r\nfor (const prop in ASSETS_PATH.SOUNDS) {\r\n  loader.add(ASSETS_PATH.SOUNDS[prop]);\r\n}\r\nsetUpLoaderProgresBar();\r\nchannel.callbackAfterDataChannelOpened = () => {\r\n  loader.load(setup);\r\n};\r\n\r\nsetUpUI();\r\n\r\n/**\r\n * Set up the loader progress bar.\r\n */\r\nfunction setUpLoaderProgresBar() {\r\n  const loadingBox = document.getElementById('loading-box');\r\n  const progressBar = document.getElementById('progress-bar');\r\n\r\n  loader.onProgress.add(() => {\r\n    progressBar.style.width = `${loader.progress}%`;\r\n  });\r\n  loader.onComplete.add(() => {\r\n    if (!loadingBox.classList.contains('hidden')) {\r\n      loadingBox.classList.add('hidden');\r\n    }\r\n  });\r\n}\r\n\r\nfunction setup() {\r\n  const pikaVolley = new PikachuVolleyballOnline(stage, loader.resources);\r\n  setUpUIAfterLoadingGameAssets(pikaVolley, ticker);\r\n  setGetSpeechBubbleNeeded(pikaVolley);\r\n  start(pikaVolley);\r\n}\r\n\r\nfunction start(pikaVolley) {\r\n  ticker.maxFPS = pikaVolley.normalFPS;\r\n  ticker.add(() => {\r\n    // Redering and gameLoop order is the opposite of\r\n    // the offline web version (refer: ./offline_version_js/main.js).\r\n    // It's for the smooth rendering for the online version\r\n    // which gameLoop can not always succeed right on this \"ticker.add\"ed code\r\n    // because of the transfer delay or connection status. (If gameLoop here fails,\r\n    // it is recovered by the callback gameLoop which is called after peer input received.)\r\n    // Now the rendering is delayed 40ms (when pikaVolley.normalFPS == 25)\r\n    // behind gameLoop.\r\n    renderer.render(stage);\r\n    pikaVolley.gameLoop();\r\n  });\r\n  ticker.start();\r\n}\r\n"],"sourceRoot":""}